# Обновление системы начисления бонусов

## ✅ Изменения

### Начисление бонусов при доставке заказа

Бонусы теперь начисляются автоматически при изменении статуса заказа на `DELIVERED` (доставлен), а не при оплате.

**Условия начисления:**
- ✅ Заказ должен иметь статус `DELIVERED`
- ✅ Заказ должен быть оплачен (`paymentStatus === 'PAID'`)
- ✅ У заказа должен быть пользователь (`userId`)
- ✅ Бонусы начисляются только один раз за заказ (проверка по `BonusTransaction`)

**Размер бонусов:**
- 1% от итоговой суммы заказа
- 1 бонус = 1 рубль

### Измененные файлы

1. **`server/utils/bonus.ts`** (новый файл)
   - Утилита `awardBonusForDeliveredOrder()` для начисления бонусов
   - Проверяет все условия перед начислением
   - Создает запись в `BonusTransaction`

2. **`server/api/orders/[id].put.ts`**
   - Обновлен: бонусы начисляются при изменении статуса на `DELIVERED`
   - Удалена старая логика начисления при оплате

3. **`server/api/orders/[id]/sync-status.post.ts`**
   - Добавлено начисление бонусов при синхронизации статуса из iikoCloud
   - Бонусы начисляются, если статус изменился на `DELIVERED`

4. **`server/api/aiko/sync-orders-status.post.ts`**
   - Добавлено начисление бонусов при массовой синхронизации статусов
   - Бонусы начисляются для всех заказов, статус которых изменился на `DELIVERED`

5. **`server/api/aiko/orders/[aikoOrderId]/status.get.ts`**
   - Добавлено начисление бонусов при получении статуса заказа из iikoCloud

### Как это работает

1. Заказ создается и отправляется в iikoCloud
2. Статус заказа синхронизируется из iikoCloud (автоматически или вручную)
3. Когда статус меняется на `DELIVERED`:
   - Проверяется, что заказ оплачен
   - Проверяется, что бонусы еще не начислялись
   - Начисляется 1% от суммы заказа
   - Создается запись в истории транзакций
   - Обновляется баланс пользователя

### Отображение бонусов

Бонусы отображаются в профиле пользователя:
- **Баланс бонусов**: `/profile` → вкладка "Бонусы"
- **История начислений**: список всех транзакций с описанием

### API Endpoints

- `GET /api/profile/bonuses` - получение баланса и истории бонусов
- Все endpoints обновления статуса заказа теперь начисляют бонусы при доставке

### Тестирование

Для проверки работы системы:

1. Создайте заказ через сайт
2. Убедитесь, что заказ оплачен (`paymentStatus === 'PAID'`)
3. Измените статус заказа на `DELIVERED` (через админку или синхронизацию из iikoCloud)
4. Проверьте баланс бонусов в профиле пользователя
5. Проверьте историю начислений

### Примечания

- Бонусы начисляются только за оплаченные заказы
- Бонусы начисляются только один раз за заказ
- Если система бонусов не настроена в БД, начисление пропускается без ошибок
- Все ошибки логируются, но не прерывают обновление статуса заказа

