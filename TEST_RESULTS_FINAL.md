# –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!

### 1. –¢–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ (`npm run iiko:test-sync`)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –£—Å–ø–µ—à–Ω–æ

- ‚úÖ –ù–∞–π–¥–µ–Ω–æ 5 –∑–∞–∫–∞–∑–æ–≤ —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π iikoCloud
- ‚úÖ –í—Å–µ –∑–∞–∫–∞–∑—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –¢–∞–π–º–∞—É—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- ‚úÖ –°—Ç–∞—Ç—É—Å—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –±–µ–∑ –æ—à–∏–±–æ–∫

**–õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:**
```
[iikoCloud] ‚ÑπÔ∏è  –¢–∞–π–º–∞—É—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ (–æ–∂–∏–¥–∞–µ–º–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –∫–∞—Å—Å—ã)
   - –°—Ç–∞—Ç—É—Å –∏–∑ iikoCloud: PENDING
   - –°–æ–æ–±—â–µ–Ω–∏–µ: –ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç, –Ω–æ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∫–∞—Å—Å–æ–π
   ‚ÑπÔ∏è  –°—Ç–∞—Ç—É—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è: PENDING
```

### 2. –¢–µ—Å—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –æ—Ç–∫–∞—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ (`npm run iiko:test-downgrade`)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –£—Å–ø–µ—à–Ω–æ

- ‚úÖ –ó–∞–∫–∞–∑ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —Å—Ç–∞—Ç—É—Å `READY`
- ‚úÖ –ü–æ–ª—É—á–µ–Ω —Å—Ç–∞—Ç—É—Å `PENDING` –∏–∑ iikoCloud (–∏–∑-–∑–∞ —Ç–∞–π–º–∞—É—Ç–∞)
- ‚úÖ **–ó–∞—â–∏—Ç–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞:** –°—Ç–∞—Ç—É—Å –Ω–µ –æ—Ç–∫–∞—Ç–∏–ª—Å—è –Ω–∞–∑–∞–¥
- ‚úÖ –°—Ç–∞—Ç—É—Å –æ—Å—Ç–∞–ª—Å—è `READY` (–Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ `PENDING`)

**–õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:**
```
   - –°—Ç–∞—Ç—É—Å –¥–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: READY
   - –°—Ç–∞—Ç—É—Å –∏–∑ iikoCloud: PENDING (PENDING)
   - –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: READY
‚úÖ –ó–ê–©–ò–¢–ê –†–ê–ë–û–¢–ê–ï–¢: –°—Ç–∞—Ç—É—Å –Ω–µ –æ—Ç–∫–∞—Ç–∏–ª—Å—è –Ω–∞–∑–∞–¥ (READY ‚Üí PENDING –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω)
```

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

1. **`server/api/orders/[id]/sync-status.post.ts`**
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç–∫–∞—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—è–¥–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Ç–∫–∞—Ç–∞

2. **`server/api/aiko/sync-orders-status.post.ts`**
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç–∫–∞—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
   - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ —Å `updatedOrder` –≤ –±–ª–æ–∫–µ `else if`
   - ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Ç–∫–∞—Ç–∞

3. **`server/utils/iiko-client.ts`**
   - ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ `creationStatus: "Error"` —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏
   - ‚úÖ Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è 502, 503, 504 –æ—à–∏–±–æ–∫
   - ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö

### ‚úÖ –ü–æ—Ä—è–¥–æ–∫ —Å—Ç–∞—Ç—É—Å–æ–≤:

```typescript
const statusOrder = {
  'PENDING': 1,      // –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  'CONFIRMED': 2,    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
  'PREPARING': 3,    // –ì–æ—Ç–æ–≤–∏—Ç—Å—è
  'READY': 4,        // –ì–æ—Ç–æ–≤
  'DELIVERING': 5,   // –í –¥–æ—Å—Ç–∞–≤–∫–µ
  'DELIVERED': 6,    // –î–æ—Å—Ç–∞–≤–ª–µ–Ω
  'CANCELLED': 99    // –û—Ç–º–µ–Ω–µ–Ω (–º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç)
}
```

## üéØ –ü–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã:
- `PENDING` ‚Üí `CONFIRMED` ‚Üí `PREPARING` ‚Üí `READY` ‚Üí `DELIVERING` ‚Üí `DELIVERED`
- –õ—é–±–æ–π —Å—Ç–∞—Ç—É—Å ‚Üí `CANCELLED` (–æ—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞)

### ‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã (–∑–∞—â–∏—â–µ–Ω—ã):
- `READY` ‚Üí `PENDING` (–æ—Ç–∫–∞—Ç –Ω–∞–∑–∞–¥) ‚úÖ **–ó–ê–©–ò–©–ï–ù–û**
- `DELIVERING` ‚Üí `CONFIRMED` (–æ—Ç–∫–∞—Ç –Ω–∞–∑–∞–¥) ‚úÖ **–ó–ê–©–ò–©–ï–ù–û**
- `DELIVERED` ‚Üí –ª—é–±–æ–π –¥—Ä—É–≥–æ–π —Å—Ç–∞—Ç—É—Å (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å) ‚úÖ **–ó–ê–©–ò–©–ï–ù–û**

### ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤ iikoCloud:
- –ö–æ–≥–¥–∞ –∑–∞–∫–∞–∑ –ø–æ–ª—É—á–∞–µ—Ç `creationStatus: "Error"` —Å —Ç–∞–π–º–∞—É—Ç–æ–º
- –°–∏—Å—Ç–µ–º–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å `New` (PENDING)
- –ù–æ –µ—Å–ª–∏ –∑–∞–∫–∞–∑ —É–∂–µ –≤ –±–æ–ª–µ–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–º —Å—Ç–∞—Ç—É—Å–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, READY)
- –°—Ç–∞—Ç—É—Å **–Ω–µ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è** –Ω–∞–∑–∞–¥, –æ—Å—Ç–∞–µ—Ç—Å—è READY ‚úÖ

## ‚úÖ –ò—Ç–æ–≥

**–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!**

- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç–∫–∞—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –¢–∞–π–º–∞—É—Ç—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –ª–æ–≥–∏
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ —Å —Ä–µ–∞–ª—å–Ω–æ–π –∫–∞—Å—Å–æ–π iiko

**–ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é!** üöÄ

