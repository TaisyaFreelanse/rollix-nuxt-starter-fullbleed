# Обращение в поддержку iikoCloud API

## Проблема
При попытке получить внешнее меню через API `/api/2/menu/by_id` получаем ошибку **500 Internal Server Error**.

## Шаги воспроизведения

### 1. Получение списка внешних меню
**Запрос:**
```
POST https://api-ru.iiko.services/api/2/menu
Authorization: Bearer <токен>
Content-Type: application/json

{
  "organizationIds": ["2584ca7e-77e0-4175-908f-778dc3df2d1b"]
}
```

**Ответ (успешный):**
```json
{
  "correlationId": "...",
  "externalMenus": [
    {
      "id": "67847",
      "name": "Меню 1.1"
    }
  ],
  "priceCategories": [
    {
      "id": "00000000-0000-0000-0000-000000000000",
      "name": "Базовая категория"
    }
  ]
}
```

### 2. Получение меню по ID
**Запрос:**
```
POST https://api-ru.iiko.services/api/2/menu/by_id
Authorization: Bearer <токен>
Content-Type: application/json

{
  "externalMenuId": "67847",
  "organizationIds": ["2584ca7e-77e0-4175-908f-778dc3df2d1b"],
  "priceCategoryId": "00000000-0000-0000-0000-000000000000",
  "version": 2
}
```

**Ответ (ошибка 500):**
```
Status: 500 Internal Server Error
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="robots" content="noindex,nofollow,noarchive" />
    <title>An Error Occurred: Internal Server Error</title>
    ...
</head>
<body>
    ...
</body>
</html>
```

## Детали запроса

- **Organization ID:** `2584ca7e-77e0-4175-908f-778dc3df2d1b`
- **External Menu ID:** `67847` (получен из ответа `/api/2/menu`)
- **External Menu Name:** "Меню 1.1"
- **Price Category ID:** `00000000-0000-0000-0000-000000000000` (используем для "цен из меню", как рекомендовано поддержкой)
- **Version:** `2` (согласно документации API)

## Что мы пробовали

1. ✅ Использовали `externalMenuId` как строку `"67847"` (как возвращает API `/api/2/menu`)
2. ✅ Использовали `externalMenuId` как число `67847`
3. ✅ Добавили параметр `version: 2` (как в примерах документации)
4. ✅ Добавили параметр `priceCategoryId: "00000000-0000-0000-0000-000000000000"` (как рекомендовано поддержкой)
5. ✅ Проверили права доступа API ключа (все необходимые права включены)
6. ✅ Добавили расширенное логирование для анализа полных ответов API
7. ⚠️ Рассматриваем возможность использования формата `"67847#1"` (как в примерах документации `"15#3"`), но API `/api/2/menu` возвращает просто `"67847"` без формата "#число"

## Вопросы к поддержке

1. **Критический вопрос:** Почему API `/api/2/menu/by_id` возвращает ошибку 500 при корректном запросе со всеми необходимыми параметрами?

2. **Формат externalMenuId:** 
   - В документации API все примеры используют формат `"15#3"` (строка "число#число")
   - Но API `/api/2/menu` возвращает просто `"67847"` без формата "#число"
   - Нужно ли преобразовывать `"67847"` в формат `"67847#1"` или `"67847#0"` для запроса `/api/2/menu/by_id`?
   - Или API должен принимать `"67847"` как есть?

3. **Структура ответа:** Можете ли предоставить пример полного успешного ответа от `/api/2/menu/by_id` для меню с ID `67847`?

4. **Настройки меню:** Может ли проблема быть связана с настройками меню "Меню 1.1" (ID: 67847) в iiko Web? Есть ли какие-то специальные требования?

5. **Дополнительные параметры:** Есть ли какие-то скрытые или обязательные параметры, которые не указаны в документации, но требуются для работы API?

6. **Логирование:** Можете ли предоставить server-side логи iikoCloud API для нашего запроса, чтобы понять причину ошибки 500?

## Дополнительная информация

- **API Key:** имеет все необходимые права доступа:
  - Работа с API
  - Просмотр внешнего меню
  - Создание заказов
  - Просмотр заказов
- **Меню в iiko Web:** настроено, активно, содержит товары с ценами
- **Настройка цен:** используется "Базовый прайс-лист"

## Ожидаемое поведение

API должен вернуть объект меню со структурой:
```json
{
  "id": 67847,
  "name": "Меню 1.1",
  "formatVersion": 2,
  "itemCategories": [...],
  "comboCategories": [...],
  "productCategories": [...],
  ...
}
```

## Фактическое поведение

API возвращает HTTP 500 с HTML страницей ошибки вместо JSON ответа.

---


