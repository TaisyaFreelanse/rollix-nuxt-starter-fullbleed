# Обращение в поддержку iikoCloud API

## Проблема
При попытке получить внешнее меню через API `/api/2/menu/by_id` получаем ошибку **500 Internal Server Error**, несмотря на то, что все параметры запроса формируются корректно согласно документации API.

## Шаги воспроизведения

### 1. Получение списка внешних меню
**Запрос:**
```
POST https://api-ru.iiko.services/api/2/menu
Authorization: Bearer <токен>
Content-Type: application/json

{
  "organizationIds": ["2584ca7e-77e0-4175-908f-778dc3df2d1b"]
}
```

**Ответ (успешный):**
```json
{
  "correlationId": "...",
  "externalMenus": [
    {
      "id": "67847",
      "name": "Меню 1.1"
    }
  ],
  "priceCategories": [
    {
      "id": "00000000-0000-0000-0000-000000000000",
      "name": "Базовая категория"
    }
  ]
}
```

### 2. Получение меню по ID
**Запрос (текущий, корректный формат):**
```
POST https://api-ru.iiko.services/api/2/menu/by_id
Authorization: Bearer <токен>
Content-Type: application/json

{
  "externalMenuId": "67847",
  "organizationIds": ["2584ca7e-77e0-4175-908f-778dc3df2d1b"],
  "priceCategoryId": "00000000-0000-0000-0000-000000000000",
  "version": 2
}
```

**Ответ (ошибка 500):**
```
Status: 500 Internal Server Error
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="robots" content="noindex,nofollow,noarchive" />
    <title>An Error Occurred: Internal Server Error</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>❌</text></svg>" />
    <style>body { background-color: #fff; color: #222; font: 16px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; }
.container { margin: 30px; max-width: 600px; }
h1 { color: #2e49c2ff; font-size: 24px; }
h2 { font-size: 18px; }</style>
</head>
<body>
<div class="container">
    <h1>Oops! An Error Occurred</h1>
    <h2>The server returned a "500 Internal Server Error".</h2>
    <p>
        Something is broken. Please let us know what you were doing when this error occurred.
        We will fix it as soon as possible. Sorry for any inconvenience caused.
    </p>
</div>
</body>
</html>
```

**Важно:** API возвращает HTML страницу ошибки вместо JSON ответа, что указывает на критическую ошибку на стороне сервера iikoCloud.

## Детали запроса

- **Organization ID:** `2584ca7e-77e0-4175-908f-778dc3df2d1b`
- **External Menu ID:** `67847` (получен из ответа `/api/2/menu`)
- **External Menu Name:** "Меню 1.1"
- **Price Category ID:** `00000000-0000-0000-0000-000000000000` (используем для "цен из меню", как рекомендовано поддержкой)
- **Version:** `2` (согласно документации API)

## Что мы пробовали

### Варианты формата externalMenuId:
1. ✅ Использовали `externalMenuId` как строку `"67847"` (как возвращает API `/api/2/menu`) - **текущий вариант**
2. ✅ Использовали `externalMenuId` как число `67847` - ошибка 500
3. ✅ Использовали формат `"67847#1"` (как в примерах документации `"15#3"`) - ошибка 400 "External menu id does not belong to your ApiLogin"

### Варианты параметров:
4. ✅ Добавили параметр `version: 2` (как в примерах документации) - **обязателен**
5. ✅ Добавили параметр `priceCategoryId: "00000000-0000-0000-0000-000000000000"` (как рекомендовано поддержкой) - **обязателен**, без него ошибка 400 "Price category id is not correct"
6. ✅ Пробовали БЕЗ `priceCategoryId` - ошибка 400 "Price category id is not correct"

### Проверки:
7. ✅ Проверили права доступа API ключа (все необходимые права включены):
   - Работа с API
   - Просмотр внешнего меню
   - Создание заказов
   - Просмотр заказов
8. ✅ Добавили расширенное логирование для анализа полных ответов API
9. ✅ Проверили, что меню "Меню 1.1" (ID: 67847) активно в iiko Web
10. ✅ Проверили, что в меню есть товары с ценами
11. ✅ Проверили настройку "Базовый прайс-лист" для меню

### Результаты:
- **Текущий запрос** (все параметры корректны): ошибка **500 Internal Server Error**
- **Без priceCategoryId**: ошибка **400 "Price category id is not correct"**
- **С форматом "67847#1"**: ошибка **400 "External menu id does not belong to your ApiLogin"**

## Анализ проблемы

### Текущее состояние:
- ✅ Запрос формируется **корректно** согласно документации API
- ✅ Все обязательные параметры присутствуют: `externalMenuId`, `organizationIds`, `priceCategoryId`, `version`
- ✅ Формат всех параметров соответствует документации
- ❌ API возвращает **500 Internal Server Error** (критическая ошибка на стороне сервера)

### История ошибок:
1. **Без `priceCategoryId`**: ошибка 400 "Price category id is not correct" - параметр обязателен
2. **С `externalMenuId: "67847#1"`**: ошибка 400 "External menu id does not belong to your ApiLogin" - формат неверный
3. **С `externalMenuId: "67847"` (текущий)**: ошибка 500 Internal Server Error - проблема на стороне API

### Вывод:
Запрос формируется **правильно**, но API iikoCloud возвращает ошибку 500, что указывает на проблему на стороне сервера или в настройках меню в iiko Web.

## Вопросы к поддержке

1. **Критический вопрос:** Почему API `/api/2/menu/by_id` возвращает ошибку 500 при корректном запросе со всеми необходимыми параметрами? Это проблема на стороне сервера iikoCloud или в настройках меню?

2. **Формат externalMenuId:** 
   - В документации API все примеры используют формат `"15#3"` (строка "число#число")
   - Но API `/api/2/menu` возвращает просто `"67847"` без формата "#число"
   - Мы пробовали использовать `"67847"` (как возвращает API) - ошибка 500
   - Мы пробовали использовать `"67847#1"` (как в примерах) - ошибка 400 "External menu id does not belong to your ApiLogin"
   - **Какой формат правильный для нашего меню с ID `67847`?**

3. **Структура ответа:** Можете ли предоставить пример полного успешного ответа от `/api/2/menu/by_id` для меню с ID `67847`?

4. **Настройки меню:** 
   - Может ли проблема быть связана с настройками меню "Меню 1.1" (ID: 67847) в iiko Web?
   - Есть ли какие-то специальные требования к настройке меню для работы через API?
   - Нужно ли что-то дополнительно настроить в iiko Web для работы с API?

5. **Параметр priceCategoryId:**
   - Поддержка ранее рекомендовала использовать `"00000000-0000-0000-0000-000000000000"` для "цен из меню"
   - Без этого параметра API возвращает ошибку 400 "Price category id is not correct"
   - С этим параметром API возвращает ошибку 500
   - **Правильно ли мы используем этот параметр?**

6. **Логирование:** Можете ли предоставить server-side логи iikoCloud API для нашего запроса (correlationId из последнего запроса: `81f5c603-b9eb-4607-bb00-9d20cf017a97`), чтобы понять причину ошибки 500?

7. **Альтернативные методы:** Есть ли альтернативные способы получения меню через API, если `/api/2/menu/by_id` не работает?

## Дополнительная информация

- **API Key:** имеет все необходимые права доступа:
  - Работа с API
  - Просмотр внешнего меню
  - Создание заказов
  - Просмотр заказов
- **Меню в iiko Web:** настроено, активно, содержит товары с ценами
- **Настройка цен:** используется "Базовый прайс-лист"

## Ожидаемое поведение

API должен вернуть объект меню со структурой:
```json
{
  "id": 67847,
  "name": "Меню 1.1",
  "formatVersion": 2,
  "itemCategories": [...],
  "comboCategories": [...],
  "productCategories": [...],
  ...
}
```

## Фактическое поведение

API возвращает HTTP 500 с HTML страницей ошибки вместо JSON ответа. Это указывает на критическую ошибку на стороне сервера iikoCloud, а не на проблему с форматом запроса.

## Дополнительная диагностическая информация

### Последний успешный запрос к `/api/2/menu`:
- **CorrelationId:** `81f5c603-b9eb-4607-bb00-9d20cf017a97`
- **Время:** 2025-12-15 (последняя попытка)
- **Результат:** Успешно получен список меню

### Последний запрос к `/api/2/menu/by_id` (ошибка 500):
- **URL:** `https://api-ru.iiko.services/api/2/menu/by_id`
- **Метод:** POST
- **Тело запроса:**
  ```json
  {
    "externalMenuId": "67847",
    "organizationIds": ["2584ca7e-77e0-4175-908f-778dc3df2d1b"],
    "priceCategoryId": "00000000-0000-0000-0000-000000000000",
    "version": 2
  }
  ```
- **Результат:** HTTP 500 Internal Server Error (HTML страница ошибки)

### Логирование:
Мы добавили расширенное логирование, которое показывает:
- Полный ответ от `/api/2/menu` (структура меню)
- Все параметры запроса к `/api/2/menu/by_id`
- Полную информацию об ошибке (статус, URL, текст ошибки)

## Резюме

**Проблема:** API `/api/2/menu/by_id` возвращает ошибку 500 при корректном запросе.

**Попытки решения:**
- ✅ Проверены все форматы `externalMenuId` (строка, число, формат с "#")
- ✅ Проверены все варианты параметров (`priceCategoryId`, `version`)
- ✅ Проверены права доступа API ключа
- ✅ Проверены настройки меню в iiko Web

**Вывод:** Запрос формируется правильно согласно документации, но API возвращает ошибку 500, что указывает на проблему на стороне сервера iikoCloud или в настройках меню.

---
**Дата обращения:** 2025-12-15  
**Время последней попытки:** текущее время  
**Версия API:** 2  
**CorrelationId последнего запроса:** `81f5c603-b9eb-4607-bb00-9d20cf017a97`


